<html>
  <head>
    <title>Test page</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="../nice.js"></script>
  </head>
  <body style="margin:0">
<script>
"use strict";
const { RBox, Box, Div, Span, H1, H2, H3, B, I, A, next, Html, Img } = nice;
const { Arr, Type, Check, Mapping, Switch, is, 
   get, expect, Num, Str, Obj } = nice;


const colors = {
  creator: 'rgb(0, 200, 0)',
  belt: 'rgb(200, 200, 200)',
  seller: 'rgb(200, 0, 200)'
};

const prices = {
  creator: 1000,
  belt: 50,
  seller: 500
};

const balance = Num(0);
const screenSize = 400;

Div().backgroundColor('#888').padding('.2rem')
  .Div(balance, '$').fontFamily('monospace').color('gold').up
  .show();
  
const c = Html('Canvas')
  c.attributes.set('width', screenSize)
  c.attributes.set('height', screenSize)
const canvas = c.show();
canvas.addEventListener('click', function(e) {
  const slot = getSlot({x: e.layerX, y: e.layerY});
  if(selected() && !slots[slot]) {
    const price = prices[selected()];
    if(balance.gte(price)){
      slots[slot] = {type: selected()};
      balance.inc(-price);
    }
  };
});

const selected = Str();
Div(prices, (v,k) => RBox(selected, s => Div().padding('.5rem')
  .backgroundColor(s.is(k) ? 'red' : '#fff')
  .on('click', () => selected(k))
  .Div(nice.capitalize(k), ': ', v, '$').backgroundColor(colors[k]).up)
).show();

const slots = new Array(400);
const slotSize = 20;
const nSlots = screenSize / slotSize;

slots[2] = {type: 'creator'}; 
slots[3] = {type: 'belt'}; 
slots[23] = {type: 'belt'}; 
slots[43] = {type: 'seller'}; 

let t = 0;
function draw() {
  t++;
  if (canvas.getContext && t % 3) {
    const c = canvas.getContext('2d');
    c.clearRect(0, 0, screenSize, screenSize);
    drawNet(c);

    slots.forEach((f, n) => {
      c.fillStyle = colors[f.type];
      const {x,y} = getSlotXY(n);  
      c.fillRect(x, y, slotSize, slotSize);
    });

    c.fillStyle = 'rgb(200, 0, 0)';
    balls.each(b => {
      c.fillRect(b.x, b.y, slotSize / 2, slotSize / 2);
    });

  }
  window.requestAnimationFrame(draw);
}

const balls = Arr();


function getSlot(i){
  return (i.x / slotSize | 0)  + (i.y / slotSize | 0) * nSlots;
}

function getSlotXY(i){
  return { x: (i % nSlots | 0) * slotSize, y: (i / nSlots | 0) * slotSize};
}

const actions = {
  creator: (f, id, n) => {
    if(n % 20 === 0) {
      const {x,y} = getSlotXY(id);
      balls.push({x: x + slotSize, y: y})
    };
  }, 
}
const moves = {
  belt: (b, s, id, n) => {
    b.y++;
  }, 
  seller: (b, s, id, n) => {
    balls.removeValue(b);
    balance.inc(10);
  }, 
}

function drawNet(c){
  c.fillStyle = 'rgb(200, 200, 200)';
  c.beginPath();
  nice.times(nSlots, n => {
    const x = (n + 1) * slotSize - .5;
    c.moveTo(x, 0);
    c.lineTo(x, screenSize);
    c.moveTo(0, x);
    c.lineTo(screenSize, x);
  });
  c.lineWidth = .5;
  c.stroke();  
}


let n = 0;
setInterval(() => {
  n++;
  slots.forEach((f, id) => actions[f.type] && actions[f.type](f, id, n));
  balls.eachRight(b => {
    const slotId = getSlot(b);
    const slot = slots[slotId];
    slot && moves[slot.type] && moves[slot.type](b, slot, slotId, n);
  });
}, 34);

draw();
</script>
  
  </body>
</html>
