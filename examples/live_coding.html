<html>
  <head>
    <title>Ball game example</title>
    <script src="../nice.js"></script>
  </head>
  <body style="margin:0;overflow: hidden;">
<script>
const { Div, H1, B, Box, RBox, BoxSet, clamp } = nice;  
const { Textarea, Input } = nice;  

const doc = nice.generateDoc();
const codes = BoxSet();
const values = BoxSet();
const inputs = BoxSet();
const valueView = Box();
const activeItem = Box('mainPain');

const resolve = (name) => {
  const local = values.get(name);
  return local ? local() : nice[name];
};


const names = Box([]);
const codeViews = RBox(names, ns => {
  return Div(...ns.map(name => {
    const value = codes.get(name)();
    const editor = Textarea(value).width('100%').wrap('off').rows(8);
    
    editor.value.on('state', v => {
      codes.get(name)(v);
    });
    return Div()
      .on('click', () => activeItem(name))
      .h3(name)
      .add(editor)
      .add(inputsList());
  }));
});

function createUnit(name, value = ''){
  const codeBox = Box(value);
  codes.set(name, codeBox);
  
  const valueBox = Box();
  values.set(name, valueBox);
  
  names.push(name);
  codeBox.subscribe(code => {
    const fs = [];
    const tracker = f => {
      fs.push(f);
      let cursor = '';
      
    };
    
    const MAX_ATTEMPTS = 10;
    const ins = [];
    let done = false, attempts = 0;
    
    nice.reflect.onFunctionUse = tracker;
    while(!done){
      if(attempts++ >= MAX_ATTEMPTS){
        value = new Error('Too many attempts.');
        break;
      }
      try {
        const f = new Function(...ins, 'return (' + code + ');');
        const vs = [];
        for(name of ins){
          const value = resolve(name);
          if(value === undefined){
            done = true;
            throw name + ' not found!';
          } else {
            vs.push(value);
          }
        }
        valueBox(f(...vs));
        done = true;
      } catch (e) {
        valueBox('' + e);
          if(e.constructor === ReferenceError){
            let inputName = e.message.split(' ')[0];
            ins.push(inputName);
            console.log(inputName, 'missing');
  //          const input = this.base.get(inputName);
  //          input.listeners.add(this);
  //          vs.push(input.value);
          } else {
            value = e;
          }
      }
    }
    delete nice.reflect.onFunctionUse;
    console.log('Used functions: ', fs.length, ...fs);
  });
  return codeBox;
}

createUnit('mainPain', `H1('Hi').add(qwe)`);
createUnit('qwe', `world`);

function newView(){
  const input = Input();//.on();
  input.on('keyup', e => {
    if(e.code === 'Enter'){
      const name = input.value();
      name && createUnit(name);
      input.value('');
    }
  });
  return Div(Div('Create new:'), input).margin('1rem 0');
}

function inputsList(a = ['map', 'H1']){
  return a.map(name => {
    const local = values.get(name);
    const lib = nice[name];
    return Div().color('#666')
      .b( local ? name : 'nice.'+name, ': ' )
      .add( local ? '' + local() : lib.description || ("" + lib));
  });
};

const namesList = RBox(names, activeItem, (ns, active) => {
  return Div(...ns.map(name => {
    return Div(name === active ? B(name) : name);
  }));
});

const resultPane = RBox(activeItem, active => Div(values.get(active)));

Div(
  Div(namesList).backgroundColor('#bbb').padding('.5rem'),
  Div(codeViews, newView()).backgroundColor('#ddd').padding('.5rem'),
  Div(resultPane).padding('.5rem')
).display('grid')
  .gridTemplateColumns('10% 45% 45%')
  .minHeight('100%')
  .show();



</script>
  </body>
</html>
