<html>
  <head>
    <title>Live coding</title>
    <!--<script src="https://unpkg.com/esprima@~4.0/dist/esprima.js"></script>-->
    <script src="../nice.js"></script>
  </head>
  <body style="margin:0;">
<script>
//TODO: history
//TODO: ?? composite items
//TODO: tests placements

//TODO: syncronius warmup
//TODO: how to display(orderly) object(no order)

const { Div, H1, B, A, Box, RBox, BoxSet, clamp, Err } = nice;  
const { Textarea, Input } = nice;
const history = [];

const doc = nice.generateDoc();
const codes = BoxSet();
const values = BoxSet();
const inputs = BoxSet();
const valueView = Box();
const activeItem = Box('mainPane');
const missingItems = {};
const imports = {};
let test;

//TODO: //BUG: name "name" dont work

const resolve = (name) => {
  const local = values.get(name);
  if(local){
    return local;
  } else {
    if(nice[name]){
      const box = nice.LiveBox(`nice["${name}"]`);
      imports[name] = box;
      return box;
    } else {
      const box = nice.LiveBox(`Err('Name "${name}" not found')`);
      missingItems[name] = box;
      return box;
    }
  }
};

const MAX_ATTEMPTS = 10;
const IS_READY = 1;
const IS_LOADING = 2;
const IS_HOT = 4;

function createGet(){
  const res = function(name){
    return resolve(name)();
  };
  
  return res;
}

  
function createSet(){
  const res = function(name, value){
    return resolve(name)(value);
  };
  
  return res;
}


nice.Type({
  name: 'LiveBox',
  
  extends: 'RBox', 
  
  initBy: (z, code = '') => {
    z._status = 0;
    z._inputs = [];
    z._inputNames = [];
    z._inputValues = [];
    z._inputListeners = new Map();
    z.setCode(code);
  },
  
  customCall: (z, ...as) => {
    if(as.length === 0)
      return z._value;

    z.setCode(as[0]);
    z.attemptCompute();
  },
  
  proto: {
    setCode (code) {
      if(code){
        this._code = code;
      } 
      try {
        this._by = new Function('get', 'set', ...this._inputNames, 'return (' + this._code + ');');
      } catch (e) {
        this._by = () => e;
      }
    },
    attemptCompute () {
//      if(!this._inputValues.every(v => v !== undefined))
//        return;
      
      if(this.attempts === undefined){
        this.attempts = 0;
      } else if (this.attempts++ > MAX_ATTEMPTS){
        this.setState(Err('To many attempts'));
        delete this.attempts;
        return;  
      }
      
      let value;
      try {
        value = this._by(createGet(), createSet(), ...this._inputValues);
      } catch (e) {
        const bool = nice.isError(e);
        if(e.constructor === ReferenceError){
          const inputName = e.message.split(' ')[0];
          const input = resolve(inputName);
          this._inputNames.push(inputName);
          this._by = new Function('get', 'set', ...this._inputNames, 'return (' + this._code + ');');
          this.reconfigure(...this._inputs, input, this._by);  
          return;
        } 
        this.setState(e);
      }
      
      this.setState(value);
      this._status &= ~IS_LOADING;
      this._status |= IS_READY;

      delete this.attempts;
      return;
    }
  }
});


function childrenBlock(name){
  return RBox(resolve(name), value => {
    return value && value._isObj ? 1 :2;
  });
}


function resultFrame(box){
  return RBox(box, value => {
    const color = nice.isError(value)
      ? 'red'
      : 'green';
      
    return Div('Result: ')
      .Div(value)
        .backgroundColor('#fff')
        .border('3px', color, 'solid')
        .padding('.5rem')
        .up
  })
};



const names = Box([]);
const codeViews = RBox(names, ns => {
  return Div(...ns.map(name => {
    const editorOn = Box(false);
    const code = Box(codes.get(name)());
    const editor = RBox(editorOn, on => on 
      ? Div()
        .Textarea(code).width('100%').wrap('off').rows(6).up
        .a(() => editorOn(false), 'Save')
      : A(() => editorOn(true), 'Edit')
    );
    const value = nice.LiveBox();
    code.subscribe(v => value(v));
    
    return Div()
      .on('click', () => activeItem(name))
      .h3(name)
      .Div(codes.get(name))
        .whiteSpace('pre')
        .padding('.5rem')
        .backgroundColor('#eee')
        .up
      .add(editor)
//      .add(childrenBlock(name))
      .add(resultFrame(value))
//      .add(inputsList());
  }));
});

function createUnit(name, value = ''){
  const codeBox = Box(value);
  codes.set(name, codeBox);
  
  let valueBox;
  if(missingItems[name]){
    valueBox = missingItems[name];
    delete missingItems[name];
  } else if (imports[name]) {
    valueBox = imports[name];
    delete imports[name];
  } else {
    valueBox = nice.LiveBox();
  }
  values.set(name, valueBox);
  
  names.push(name);
  codeBox.subscribe(code => valueBox(code));
  
  return codeBox;
}

function newView(){
  const input = Input();
  input.on('keyup', e => {
    if(e.code === 'Enter'){
      const name = input.value();
      name && createUnit(name);
      input.value('');
    }
  });
  return Div(Div('Create new:'), input).margin('1rem 0');
}

function inputsList(a = ['map', 'H1']){
  return a.map(name => {
    const local = values.get(name);
    const lib = nice[name];
    return Div().color('#666')
      .b( local ? name : 'nice.'+name, ': ' )
      .add( local ? '' + local() : lib.description || ("" + lib));
  });
};

const namesList = RBox(names, activeItem, (ns, active) => {
  return Div(...ns.map(name => {
    return RBox(resolve(name), value => 
        Div(name === active ? B(name) : name)
          .color(value._isErr || value  instanceof Error ? '#ce0404' : 'black')
          .on('click', () => activeItem(name)));
  }));
});

const resultPane = RBox(activeItem, active => Div(values.get(active)));

Div(
  Div(namesList).backgroundColor('#bbb').padding('.5rem'),
  Div(codeViews, newView()).overflow('auto').backgroundColor('#ddd').padding('.5rem'),
  Div(resultPane).padding('.5rem')
).display('grid')
  .gridTemplateColumns('10% 45% 45%')
  .height('100%')
  .show();


function extractNames (code){
  const tokens = esprima.tokenize(code);
  const result = {};
  const ignored = {};
  let ignoreNext = false;
  
  tokens.forEach(({type, value}) => {
    if(type === 'Keyword'){
      if(value === 'var' || value === 'const' || value === 'let'){
        ignoreNext = true;
        return;
      }
    } else if (type === 'Identifier') {
      if(ignoreNext){
        ignored[value] = 1;
      } else {
        ignored[value] || (result[value] = 1);
      }
    }
    ignoreNext = false;
  });
  
  return result;
}



//createUnit('mainPane', `H2('Hello ').add(qwe).a(() => codes.get('qwe')('"wwwwwwwwwwww2"'), 'qwe')`);
//createUnit('mainPane', `H2('Hello ').add(qwe)`);
//createUnit('qwe', `world`);

createUnit('mainPane', `H2('Hello ')
  .add(messages.map(m => Div(m)))
  .add(input)`);
createUnit('messages', `['Hi all']`);
createUnit('input', `Input().on('keyup', e => {
    if(e.code === 'Enter'){
      const input = e.srcElement;
      const text = input.value;
      text && set('messages', [...get('messages'), text]);
      input.value = '';
    }
  })`);




</script>
  </body>
</html>
