<html>
  <head>
    <title>Ball game example</title>
    <script src="../nice.js"></script>
  </head>
  <body style="margin:0;overflow: hidden;">
<script>
const { Div, H1, B, Box, RBox, BoxSet, clamp, Err } = nice;  
const { Textarea, Input } = nice;  

const doc = nice.generateDoc();
const codes = BoxSet();
const values = BoxSet();
const inputs = BoxSet();
const valueView = Box();
const activeItem = Box('mainPain');
const missingItems = {};
const imports = {};

//TODO: //BUG: name "name" dont work

const resolve = (name) => {
  const local = values.get(name);
  if(local){
    return local;
  } else {
    if(nice[name]){
      const box = nice.LiveBox(`nice["${name}"]`);
      imports[name] = box;
      return box;
    } else {
      const box = nice.LiveBox(`Err('Name "${name}" not found')`);
      missingItems[name] = box;
      return box;
    }
  }
};

const MAX_ATTEMPTS = 10;
const IS_READY = 1;
const IS_LOADING = 2;
const IS_HOT = 4;

nice.Type({
  name: 'LiveBox',
  
  extends: 'RBox', 
  
  initBy: (z, code = '') => {
    z._status = 0;
    z._inputs = [];
    z._inputNames = [];
    z._inputValues = [];
    z._inputListeners = new Map();
    z.setCode(code);
  },
  
  proto: {
//    addInput (name) {
//      const input = resolve(name);
//      this._inputNames.push(name);
//      this._inputs.push(input);
//      this._inputValues = this._inputs.map(v => v._value);
//      this.setCode();
//    },
    setCode (code) {
      if(code){
        this._code = code;
      } 
      try {
        this._by = new Function(...this._inputNames, 'return (' + this._code + ');');
      } catch (e) {
//        this._by = () => 'Temp by';
        this.setState(e);
      }
    },
    attemptCompute () {
//      if(!this._inputValues.every(v => v !== undefined))
//        return;
      
      if(this.attempts === undefined){
        this.attempts = 0;
      } else if (this.attempts++ > MAX_ATTEMPTS){
        this.setState(Err('To many attempts'));
        delete this.attempts;
        return;  
      }
      
      try {
        const value = this._by(...this._inputValues);
        this.setState(value);
        this._status &= ~IS_LOADING;
        this._status |= IS_READY;
      } catch (e) {
        if(e.constructor === ReferenceError){
//          this.addInput(e.message.split(' ')[0]);
          const inputName = e.message.split(' ')[0];
          const input = resolve(inputName);
          this._inputNames.push(inputName);
          this._by = new Function(...this._inputNames, 'return (' + this._code + ');');
          this.reconfigure(...this._inputs, input, this._by);  
//          this.attemptCompute();
          return;
        } 
        this.setState(e);
      }
      delete this.attempts;
      return;
    }
  }
});


const names = Box([]);
const codeViews = RBox(names, ns => {
  return Div(...ns.map(name => {
    const value = codes.get(name)();
    const editor = Textarea(value).width('100%').wrap('off').rows(8);
    
    editor.value.on('state', v => codes.get(name)(v));
    return Div()
      .on('click', () => activeItem(name))
      .h3(name)
      .add(editor)
      .add(inputsList());
  }));
});

function createUnit(name, value = ''){
  const codeBox = Box(value);
  codes.set(name, codeBox);
  
  let valueBox;
  if(missingItems[name]){
    valueBox = missingItems[name];
    delete missingItems[name];
  } else if (imports[name]) {
    valueBox = imports[name];
    delete imports[name];
  } else {
    valueBox = nice.LiveBox();
  }
  values.set(name, valueBox);
  
  names.push(name);
  codeBox.subscribe(code => {
    valueBox.setCode(code);
    valueBox.attemptCompute();
  });
  
  return codeBox;
}

function newView(){
  const input = Input();//.on();
  input.on('keyup', e => {
    if(e.code === 'Enter'){
      const name = input.value();
      name && createUnit(name);
      input.value('');
    }
  });
  return Div(Div('Create new:'), input).margin('1rem 0');
}

function inputsList(a = ['map', 'H1']){
  return a.map(name => {
    const local = values.get(name);
    const lib = nice[name];
    return Div().color('#666')
      .b( local ? name : 'nice.'+name, ': ' )
      .add( local ? '' + local() : lib.description || ("" + lib));
  });
};

const namesList = RBox(names, activeItem, (ns, active) => {
  return Div(...ns.map(name => {
    return Div(name === active ? B(name) : name)
        .on('click', () => activeItem(name));
  }));
});

const resultPane = RBox(activeItem, active => Div(values.get(active)));

Div(
  Div(namesList).backgroundColor('#bbb').padding('.5rem'),
  Div(codeViews, newView()).backgroundColor('#ddd').padding('.5rem'),
  Div(resultPane).padding('.5rem')
).display('grid')
  .gridTemplateColumns('10% 45% 45%')
  .minHeight('100%')
  .show();


createUnit('mainPain', `H2('Hello ').add(qwe)`);
createUnit('qwe', `world`);



</script>
  </body>
</html>
