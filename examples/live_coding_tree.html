<html>
  <head>
    <title>Live coding</title>
    <!--<script src="https://unpkg.com/esprima@~4.0/dist/esprima.js"></script>-->
    <script src="../nice.js"></script>
  </head>
  <body style="margin:0;">
<script>
//TODO: history
//TODO: ?? composite items
//TODO: tests placements

//TODO: syncronius warmup
//TODO: how to display(orderly) object(no order)

const { Div, H1, B, A, I, Span, Box, RBox, BoxSet, clamp, Err } = nice;  
const { Textarea, Input } = nice;

const names = Box([]);
//TODO: //BUG: name "name" dont work

const MAX_ATTEMPTS = 10;
const IS_READY = 1;
const IS_LOADING = 2;
const IS_HOT = 4;


nice.Type({
  name: 'LiveBox',
  
  extends: 'RBox', 
  
  initBy: (z, code = '') => {
    z._status = 0;
    z._inputs = [];
    z._inputNames = [];
    z._inputValues = [];
    z._inputListeners = new Map();
    z.codes = BoxSet();
    z.values = BoxSet();
    z.inputs = BoxSet();
    z.missingItems = {};
    z.imports = {};
    z.setCode(code);
  },
  
  customCall: (z, ...as) => {
    if(as.length === 0)
      return z._value;

    z.setCode(as[0]);
    z.attemptCompute();
  },
  
  proto: {
    setCode (code) {
      if(code){
        this._code = code;
      } 
      try {
        this._by = new Function('get', 'set', ...this._inputNames, 'return (' + this._code + ');');
      } catch (e) {
        this._by = () => e;
      }
    },
    attemptCompute () {
//      if(!this._inputValues.every(v => v !== undefined))
//        return;
      
      if(this.attempts === undefined){
        this.attempts = 0;
      } else if (this.attempts++ > MAX_ATTEMPTS){
        this.setState(Err('To many attempts'));
        delete this.attempts;
        return;  
      }
      
      let value;
      try {
        value = this._by(this.createGet(), this.setState, ...this._inputValues);
      } catch (e) {
        const bool = nice.isError(e);
        if(e.constructor === ReferenceError){
          const inputName = e.message.split(' ')[0];
          const input = this.resolve(inputName);
          this._inputNames.push(inputName);
          this._by = new Function('get', 'set', ...this._inputNames, 'return (' + this._code + ');');
          this.reconfigure(...this._inputs, input, this._by);  
          return;
        } 
        this.setState(e);
      }
      
      this.setState(value);
      this._status &= ~IS_LOADING;
      this._status |= IS_READY;

      delete this.attempts;
      return;
    },
    
    createUnit(name, value = ''){
      const codeBox = Box(value);
      this.codes.set(name, codeBox);

      let valueBox;
      if(this.missingItems[name]){
        valueBox = this.missingItems[name];
        delete this.missingItems[name];
      } else if (this.imports[name]) {
        valueBox = this.imports[name];
        delete this.imports[name];
      } else {
        valueBox = nice.LiveBox();
      }
      this.values.set(name, valueBox);

      names.push(name);
      codeBox.subscribe(code => valueBox(code));

      return codeBox;
    },
    resolve (name) {
      const local = this.values.get(name);
      if(local){
        return local;
      } else {
        if(nice[name]){
          const box = nice.LiveBox(`nice["${name}"]`);
          this.imports[name] = box;
          return box;
        } else {
          const box = nice.LiveBox(`Err('Name "${name}" not found')`);
          this.missingItems[name] = box;
          return box;
        }
      }
    },
    
    createGet(){
      const res = function(name){
        return this.resolve(name)();
      };

      return res;
    },
    
    createSet(){
      const res = function(name, value){
        return this.resolve(name)(value);
      };

      return res;
    },

    setState(name, state){
      this.resolve(name)(JSON.stringify(state));
    }
  }
});


const root = nice.LiveBox();
root.createUnit('mainPane', `Div()
  .h2('Hello ')
  .add(messages.map(m => Div(m)))
  .add(input)`);
root.createUnit('messages', `['Hi all']`);
root.createUnit('input', `Input().on('keyup', e => {
    if(e.code === 'Enter'){
      const input = e.srcElement;
      const text = input.value;
      input.value = '';
      input.dispatchEvent(new Event('change'));
      text && set('messages', [...get('messages'), text]);
    }
  })`);


//view
const valueView = Box();
const activeItem = Box('mainPane');

const codeViews = RBox(names, ns => {
  return Div(...ns.map(name));
});

function resultFrame(box){
  return RBox(box, value => {
    const color = nice.isError(value)
      ? 'red'
      : 'green';
      
    return Div('Result: ')
      .Div(value)
        .backgroundColor('#fff')
        .border('3px', color, 'solid')
        .padding('.5rem')
        .up
  })
};


A.extend('MyButton')
  .by((z, ...as) => {
    z.super(...as)
      .backgroundColor('#588fc7')
      .color('#fff')
      .borderRadius('.3rem')
      .margin('1rem .5rem .5rem 0')
      .padding('.1rem .3rem')
      .textDecoration('none')
  });

const itemDetails = name => {
  const editorOn = Box(false);
  const code = Box(codes.get(name)());
  const editor = RBox(editorOn, on => on 
    ? Div('Edit:')
      .Textarea(code).width('100%').wrap('off').rows(6).up
      .myButton(() => codes.get(name)(code()) && editorOn(false), 'Save')
      .myButton(() => editorOn(false), 'Cancel')
    : A(() => editorOn(true), 'Edit')
  );
  const value = nice.LiveBox();
  code.subscribe(v => value(v));

  return Div()
    .on('click', () => activeItem(name))
    .h3(name)
    .Div(codes.get(name))
      .fontFamily('mono')
      .whiteSpace('pre')
      .padding('.5rem')
      .backgroundColor('#eee')
      .up
    .Div(editor).margin('1rem 0').up
//      .add(childrenBlock(name))
    .Div(resultFrame(value)).margin('1rem 0').up
};

function newView(){
  const input = Input();
  input
    .placeholder('Create new:')
    .on('keyup', e => {
      if(e.code === 'Enter'){
        const name = input.value();
        name && createUnit(name);
        input.value('');
        activeItem(name);
      }
    });
  return Div(input).margin('1rem 0');
}

const namesList = RBox(names, activeItem, (ns, active) => {
  return Div(...ns.map(name => {
    return Div(name === active ? B(name) : name)
      .cursor('pointer')
      .add(' ', Span(nice.getType(resolve(name)()).name).color('#666'))
      .on('click', () => { activeItem(name); return false });
  }));
});


const resultPane = RBox(activeItem, active => Div(values.get(active)));

  
//  set('messages', [...get('messages'), text]);
//  or
//  messages.push(text);
//  or
//  addMessage(text);


Div(
  Div(newView(), namesList).backgroundColor('#bbb').padding('.5rem'),
  Div(RBox(activeItem, itemDetails))
    .overflow('auto').backgroundColor('#ddd').padding('.5rem'),
//  Div(resultPane).padding('.5rem')
).display('grid')
  .gridTemplateColumns('25% 75%')
  .height('100%')
  .show();

</script>
  </body>
</html>

