<html>
  <head>
    <title>Tic Tac Toe</title>
    <script src="../nice.js"></script>
  </head>
  <body>
<script>
const { Num, Arr, Div, H1, Ol, Li, A, Box, RBox, Button } = nice;  

const step = Box(0);

const whoseTurn = n => n % 2 ? 'o' : 'x';

const currentPlayer = RBox(step, whoseTurn);

const state = Box(Array(9).fill(null));

const history = Box([state()]);

const winCombinations = [
  [0,1,2], [3,4,5], [6,7,8], [0,3,6], [1,4,7], [2,5,8], [0,4,8], [2,4,6]
];

const gameOver = RBox(state, s => 
  winCombinations.some(l => l.map(i => s[i]).reduce((a, b) => a === b && a)));
    
const handleClick = i => {
  const current = step() + 1;
  history().length > current && history(history().slice(0, current));
  
  const a = state().slice();
  a[i] = currentPlayer();
  history.push(a);
  state(a);
  step.add(1);
};

const sellView = (v, i) => Div(v)
  .textAlign('center').font('3.2rem Arial')
  .backgroundColor('white')
  .on('click', () => gameOver() || state()[i] !== null || handleClick(i));
  
const historyButton = (s, i) => 
  Li(Button('Go to move #' + i, () => { state(s); step(i); }));
 
Div(
  H1('Tic Tac Toe'),
  RBox(state, s => Div(s.map(sellView))
      .display('inline-grid')
      .gridTemplateColumns('4rem 4rem 4rem')
      .gridTemplateRows('4rem 4rem 4rem')
      .border('3px solid #666')
      .gridGap('3px')
      .backgroundColor('#666')
      .margin('1rem 0')),
  RBox(gameOver, currentPlayer, (o, c) => o 
    ? H1('Winner: ' + whoseTurn(step() - 1))
    : Div('Next player: ' + c)),  
  RBox(history, h => Ol(h.map(historyButton))),
).show();
</script>
  </body>
</html>
