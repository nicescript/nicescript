<html>
  <head>
    <title>Tic Tac Toe</title>
    <script src="../nice.js"></script>
  </head>
  <body>
<script>
const { Num, Arr, Div, H1, Ol, Li, Box, Button } = nice;  

const step = Num(0);

const whoseTurn = n => n % 2 ? 'o' : 'x';

const current = Box.by(step, whoseTurn);

const state = Arr().fill(null, 0, 9);

const history = Arr(state());

const lines = [
  [0, 1, 2],
  [3, 4, 5],
  [6, 7, 8],
  [0, 3, 6],
  [1, 4, 7],
  [2, 5, 8],
  [0, 4, 8],
  [2, 4, 6]
];

const gameOver = Box.by(state, s => {
  s = s.json;
  return lines.some(l => l.map(i => s[i]).reduce((a, b) => a === b && a))
});
    
const handleClick = i => {
  history.size > step + 1 && history.splice(step + 1);
  state.set(i, current());
  history.push(state.json);
  step.inc();
};

const sellView = (v, i) => Div(v)
  .textAlign('center').font('3.2rem Arial')
  .width('4rem').height('4rem')
  .border('1px #000 solid')
  .margin('-1px')
  .on('click', () => gameOver() || state.get(i).is.Str() || handleClick(i));
  
const historyButton = (s, i) => 
  Li(Button('Go to move #' + i, () => { state.removeAll(); state(...s.json); step(i); }));
 
Div(
  H1('Tic Tac Toe'),
  Box.by(state, s => Div(s.map(sellView))
      .width('12rem').display('flex').flexWrap('wrap').margin('1rem 0')),
  Box.by(gameOver, current, (o, c) => o 
    ? 'Winner: ' + whoseTurn(step() - 1)
    : 'Next player: ' + c),  
  Box.by(history, h => Ol(h.map(historyButton))),
).show();
</script>
  </body>
</html>
