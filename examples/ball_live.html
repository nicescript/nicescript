<html>
  <head>
    <title>Ball game example</title>
    <script src="../nice.js"></script>
  </head>
  <body style="margin:0;overflow: hidden;">
<script>
const { Div, H1, Box, RBox, BoxSet, clamp } = nice;  
const { Textarea, Input } = nice;  
const doc = nice.generateDoc();

//let speed = 5;
//
//const ball = Box({x:0, y: 10, dx: speed, dy: speed, size: 20});
//
//const platform = Box({ x:0, width: 60, height: 20 });
//
//const gameOver = RBox(ball, b => b.y + b.size > window.innerHeight);
//
//Div(
//  RBox(ball, b => {
//    const div = Div()
//      .position('absolute')
//      .top(b.y).left(b.x)
//      .borderRadius('50%')
//      .width(b.size + 'px').height(b.size + 'px');
//
//    return gameOver()
//      ? div.add('ðŸ’¥').margin('-100px').fontSize('200px')
//      : div
//        .background('radial-gradient(circle at 30% 30%, #5cabff, #000)')
//        .borderRadius('50%')
//        .width(b.size + 'px').height(b.size + 'px');
//  }),
//  RBox(platform, p => Div().position('absolute')
//    .background('linear-gradient(#333, #777 25%, #000)')
//    .bottom(0)
//    .borderRadius(p.width / 2 + 'px')
//    .width(p.width + 'px').height(p.height + 'px')
//    .left(p.x + 'px')
//  ),
//  RBox(gameOver, over => over 
//    ? H1('You lose!').color('red')
//        .textAlign('center').position('absolute').width('100%').top('45%')
//    : ''
//  )
//).show();
//
//window.addEventListener('mousemove', e => {
//  const width = platform().width;
//  platform.assign({
//    x: clamp(e.clientX - width / 2, document.body.offsetWidth - width)
//  });
//});
//
//
//function move() {
//  let p = platform();
//  let { x, y, dx, dy, size } = ball();
//
//  dx = x + size > window.innerWidth
//    ? -speed
//    : x < 0 ? speed : dx;
//
//  const low = y + size > window.innerHeight - p.height;
//  dy = low && x > p.x && x < p.x + p.width
//    ? -speed
//    : y < 0 ? speed : dy;
//
//  gameOver() || setTimeout(move, 20);
//  ball.assign({ dx, dy, x: x + dx, y: y + dy });
//}
//move();

//      if(attempts++ >= MAX_ATTEMPTS){
//        value = new Error('Too many attempts.');
//        break;
//      }
//      try {
//        if(args.length){
//          value = Function(...args, '"use strict";return (' + this.code + ')')(...vs);
//        } else {
//          value = Function('"use strict";return (' + this.code + ')')();
//        }
//      } catch (e) {
//        if(e.constructor === ReferenceError){
//          let inputName = e.message.split(' ')[0];
//          args.push(inputName);
//          const input = this.base.get(inputName);
//          input.listeners.add(this);
//          vs.push(input.value);
//        } else {
//          value = e;
//        }
//      }

const codes = BoxSet();
const values = BoxSet();
const inputs = BoxSet();
const valueView = Box();

const resolver = new Proxy({}, {
  get (o, k, receiver) {
    console.log(k, ' requested');
    const local = values.get(k);
    return local ? local() : nice[k];
  },
});

const names = Box([]);
const codeViews = RBox(names, ns => {
  return Div(...ns.map(name => {
    const value = codes.get(name)();
    const editor = Textarea(value);
    
    editor.value.on('state', v => {
      codes.get(name)(v);
    });
    return Div()
      .h3(name)
      .add(editor)
      .add(inputsList());
  }));
});

function createUnit(name, value = ''){
  const codeBox = Box(value);
  codes.set(name, codeBox);
  
  const valueBox = Box();
  values.set(name, valueBox);
  
  names.push(name);
  codeBox.subscribe(code => {
    try {
      const f = new Function('$', 'return (' + code + ');');
      valueBox(f(resolver));
    } catch (e) {
      valueBox('' + e);
    }
  });
  return codeBox;
}

createUnit('mainPain', `H1('Hi')`);

function newView(){
  const input = Input();//.on();
  input.on('keyup', e => {
    if(e.code === 'Enter'){
      const name = input.value();
      name && createUnit(name);
      input.value('');
    }
  });
  return Div(Div('Create new:'), input).margin('1rem 0');
}

function inputsList(a = ['map', 'H1']){
  return a.map(name => {
    const local = values.get(name);
    const lib = nice[name];
    return Div().color('#666')
      .b( local ? name : 'nice.'+name, ': ' )
      .add( local ? '' + local() : lib.description || ("" + lib));
  });
};

Div(codeViews, newView()).show();

Div(values.get('mainPain')).show();


</script>
  </body>
</html>
