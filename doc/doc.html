<html>
  <head>
    <title>NiceScript documentation</title>
    <script src="../nice.js"></script>
    <style>
      Body {margin:0; font:14px Arial;}
      A {text-decoration: none;}
      A:hover {text-decoration: underline;}
    </style>
  </head>
  <body style="margin:0;">
<script>
const { Div, Span, H1, H2, Box, B, A, Input, RBox } = nice;

//const typeView = nice.memoize(title => Div(title).margin('.3em 1em'));
//const typesPane = Div();
//
//nice._each(nice.types, (v, k) => {
//  const parentTitle = v.__proto__ && v.__proto__.name;
//  ( parentTitle ? typeView(parentTitle) : typesPane ).add(typeView(k));
//});
//
//typesPane.show();
Div.extend('Code')
  .by((z, ...a) => z.super(...a)
    .backgroundColor('#ddd')
    .borderRadius('.5rem')
    .padding('.5rem')
    .whiteSpace('pre')
    .overflow('auto')
    .fontFamily('mono')
  );

const functionsPane = Div(H2('Functions').padding('1rem'));

const foundText = s => Span(s).color('#1fb300');

const inlineJS = s => Span(s.slice(1,-1))
    .backgroundColor('#ddd').padding('0 .2rem').borderRadius('.2rem');

function addTests(ts){
  return div => {
    ts.forEach(t => {
      div.Code(t).up
    })
  }
}
        

const doc = nice.generateDoc();

const highlightText = (s, re, f = B) => {
  if(!re)
    return [s];
  typeof re === 'string' && (re = RegExp(re.toLowerCase(), 'gi'));
  const res = [];
  let lastIndex = 0;
  let a = [];
  let max = 100;
  
  while ((a = re.exec(s)) !== null && max--) {
    const slice = s.slice(lastIndex, a.index);
    lastIndex = a.index + a[0].length;
    
    slice && res.push(slice);
    res.push(f(a[0]));
  }
  res.push(s.substr(lastIndex));
  return res;
};


H1('NiceScript v', nice.version).margin('1rem').show();

const search = Input("search").placeholder('Search')
  .margin('1rem').padding('.2rem .5rem')
  .focus();

search.show();


const functionType = Box('All');

RBox(functionType, t => Span(
  ['All', 'Check', 'Mapping', 'Action'].map(v => 
      (v === t ? B(v) : A(() => functionType(v), v)).padding('.5rem'))
).margin('.5rem')).show();


const functionView = f => Div().padding('1rem')
  .H3(...highlightText(f.title.toString(), search.value(), foundText))
    .I(f.functionType).color('#666').marginLeft('1rem').up
    .up
  .p(...highlightText(f.description || '', /`.*?`/g, inlineJS))
  .apply(addTests(f.tests))
//  .Div(f.action && f.action.toString()).whiteSpace('pre').up
//  .div(f.signature && f.signature.length
//      && (name += ' (' + f.signature.join(', ') + ')'));
  ;

const start = Date.now();
            
RBox(functionType, search.value, (type, q) => {
  q = q.toLowerCase();
  return Div(doc.functions.filter(f => (type === 'All' || type === f.type) 
        && (!q || f.title.toString().toLowerCase().includes(q))), functionView)
}).show();
//    .filter(f => (type === 'All' || type === f.functionType) 
//        && (!q || f.name.toString().includes(q)))
//    .map(functionView)))
//    .listen(v => {
//      console.log('TOOK: ', (Date.now() - start));
//      v.html;
//      console.log('TOOK2: ', (Date.now() - start));
//    });


</script>
  </body>
</html>
