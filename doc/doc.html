<html>
  <head>
    <title>NiceScript documentation</title>
    <script src="../nice.js"></script>
    <style>
      Body {margin: 1rem; font: 14px Arial;}
      A {text-decoration: none;}
      A:hover {text-decoration: underline;}
      H3 {margin: 2rem 0 .5rem 0;}
      P {margin: .5rem 0;}
    </style>
  </head>
  <body>
<script>
const { Div, Span, H1, H2, B, A, Input } = nice;

//const typeView = nice.memoize(title => Div(title).margin('.3em 1em'));
//const typesPane = Div();
//
//nice._each(nice.types, (v, k) => {
//  const parentTitle = v.__proto__ && v.__proto__.name;
//  ( parentTitle ? typeView(parentTitle) : typesPane ).add(typeView(k));
//});
//
//typesPane.show();
Div.extend('Code')
  .by((z, ...a) => z.super(...a)
    .backgroundColor('#eee')
    .borderRadius('.5rem')
    .padding('.5rem')
    .whiteSpace('pre')
    .overflow('auto')
    .fontFamily('mono')
  );

const foundText = s => Span(s).color('#1fb300');

const inlineJS = s => Span(s.slice(1,-1))
    .backgroundColor('#eee').padding('0 .2rem').borderRadius('.2rem');

function addTests(ts){
  return div => {
    ts.forEach(t => {
      div.Code(t).up
    })
  }
}
        

const doc = nice.generateDoc();

const highlightText = (s, re, f = B) => {
  if(!re)
    return [s];
  typeof re === 'string' && (re = RegExp(re.toLowerCase(), 'gi'));
  const res = [];
  let lastIndex = 0;
  let a = [];
  let max = 100;
  
  while ((a = re.exec(s)) !== null && max--) {
    const slice = s.slice(lastIndex, a.index);
    lastIndex = a.index + a[0].length;
    
    slice && res.push(slice);
    res.push(f(a[0]));
  }
  res.push(s.substr(lastIndex));
  return res;
};


H1('NiceScript v', nice.version).show();

const search = Input("search").placeholder('Search')
  .padding('.2rem .5rem')
  .focus();

search.show();


const functionType = Box('All');

RBox(functionType, t => Span(
  ['All', 'Check', 'Mapping', 'Action'].map(v => 
      (v === t ? B(v) : A(() => functionType(v), v)).padding('.5rem'))
).margin('.5rem')).show();

const functionView = f => Div()
  .H3(...highlightText(f.title.toString(), search.value(), foundText))
    .I(f.functionType).color('#666').marginLeft('1rem').up
    .up
  .p(...highlightText(f.description || '', /`.*?`/g, inlineJS))
  .apply(addTests(f.tests));

const typeView = t => Div()
  .h3(...highlightText(t.title, search.value(), foundText))
  .p(...highlightText(t.description || '', /`.*?`/g, inlineJS));

Div()
  .h2('Types')
  .rBox(search.value, q => {
    q = q.toLowerCase();
    const f = t => !q || t.title.toString().toLowerCase().includes(q);
    return Div(nice.filter(doc.types, f), typeView);
  })
  .h2('Functions')
  .rBox(functionType, search.value, (type, q) => {
    q = q.toLowerCase();
    const f = f => (type === 'All' || type === f.type) 
        && (!q || f.title.toString().toLowerCase().includes(q));
    return Div(doc.functions.filter(f), functionView);
  })
  .show();

</script>
  </body>
</html>
