<html>
  <head>
    <title>Live coding</title>
    <script src="https://unpkg.com/esprima@~4.0/dist/esprima.js"></script>
    <script src="../nice.js"></script>
  </head>
  <body style="margin:0;">
<script>
//TODO: history
//TODO: ?? composite items
//TODO: tests placements

//TODO: syncronius warmup
//TODO: how to display(orderly) object(no order)

const { Div, H1, B, A, I, Span, Box, RBox, BoxSet, clamp, Err } = nice;  
const { Textarea, Input } = nice;
const history = [];

const doc = nice.generateDoc();
const codes = BoxSet();
const values = BoxSet();
const inputs = BoxSet();
const valueView = Box();
const activeItem = Box('mainPane');
const missingItems = {};
const imports = {};
let test;

//TODO: //BUG: name "name" dont work

const resolve = (name) => {
  const local = values.get(name);
  if(local){
    return local;
  } else {
    if(nice[name]){
      const box = nice.LiveBox(`nice["${name}"]`);
      imports[name] = box;
      return box;
    } else {
      const box = nice.LiveBox(`Err('Name "${name}" not found')`);
      missingItems[name] = box;
      return box;
    }
  }
};

const MAX_ATTEMPTS = 10;
const IS_READY = 1;
const IS_LOADING = 2;
const IS_HOT = 4;

function createGet(){
  const res = function(name){
    return resolve(name)();
  };
  
  return res;
}

  
function createSet(){
  const res = function(name, value){
    return resolve(name)(value);
  };
  
  return res;
}



function setState(name, state){
  resolve(name)(JSON.stringify(state));
}


nice.Type({
  name: 'LiveBox',
  
  extends: 'RBox', 
  
  initBy: (z, code = '') => {
    z._status = 0;
    z._inputs = [];
    z._inputNames = [];
    z._inputValues = [];
    z._inputListeners = new Map();
    z.setCode(code);
  },
  
  customCall: (z, ...as) => {
    if(as.length === 0)
      return z._value;

    z.setCode(as[0]);
    z.attemptCompute();
  },
  
  proto: {
    setCode (code) {
      if(code){
        this._code = code;
      } 
      try {
        this._by = new Function('get', 'set', ...this._inputNames, 'return (' + this._code + ');');
      } catch (e) {
        this._by = () => e;
      }
    },
    attemptCompute () {
//      if(!this._inputValues.every(v => v !== undefined))
//        return;
      
      if(this.attempts === undefined){
        this.attempts = 0;
      } else if (this.attempts++ > MAX_ATTEMPTS){
        this.setState(Err('To many attempts'));
        delete this.attempts;
        return;  
      }
      
      let value;
      try {
        value = this._by(createGet(), setState, ...this._inputValues);
      } catch (e) {
        const bool = nice.isError(e);
        if(e.constructor === ReferenceError){
          const inputName = e.message.split(' ')[0];
          const input = resolve(inputName);
          this._inputNames.push(inputName);
          this._by = new Function('get', 'set', ...this._inputNames, 'return (' + this._code + ');');
          this.reconfigure(...this._inputs, input, this._by);  
          return;
        } 
        this.setState(e);
      }
      
      this.setState(value);
      this._status &= ~IS_LOADING;
      this._status |= IS_READY;

      delete this.attempts;
      return;
    }
  }
});


function create$(parent){
  const res = new Proxy({}, {
    get (o, k, receiver) {
//      if(k[0] === '_')
//        return undefined;
//
//      if(k === 'isPrototypeOf')
//        return Object.prototype.isPrototypeOf;
//
//      if(k === 'hasOwnProperty')
//        return Object.prototype.hasOwnProperty;

      return function(){
        
      };
    },
  });
  return res;
}


function childrenBlock(name){
  return RBox(resolve(name), value => {
    return value && value._isObj ? 1 :2;
  });
}


function resultFrame(box){
  return RBox(box, value => {
    const color = nice.isError(value)
      ? 'red'
      : 'green';
      
    return Div('Result: ')
      .Div(value)
        .backgroundColor('#fff')
        .border('3px', color, 'solid')
        .padding('.5rem')
        .up
  })
};



const names = Box([]);
const codeViews = RBox(names, ns => {
  return Div(...ns.map(name));
});


Div.extend('TabView')
  .by((z, cfg) => {
    const resultPane = Box();
    const activeTab = Box('');
    const keys = Object.keys(cfg)
    return Div()
      .Div(...keys.map(key => A(() => activeTab(key), key))).up
      .Div(resultPane).up
  });
  
A.extend('MyButton')
  .by((z, ...as) => {
    z.super(...as)
      .backgroundColor('#588fc7')
      .color('#fff')
      .borderRadius('.3rem')
      .margin('1rem .5rem .5rem 0')
      .padding('.1rem .3rem')
      .textDecoration('none')
  });

const itemDetails = name => {
  const editorOn = Box(false);
  const code = Box(codes.get(name)());
  const editor = RBox(editorOn, on => on 
    ? Div('Edit:')
      .Textarea(code).width('100%').wrap('off').rows(6).up
      .myButton(() => codes.get(name)(code()) && editorOn(false), 'Save')
      .myButton(() => editorOn(false), 'Cancel')
    : A(() => editorOn(true), 'Edit')
  );
  const value = nice.LiveBox();
  code.subscribe(v => value(v));

  return Div()
    .on('click', () => activeItem(name))
    .h3(name)
    .Div(codes.get(name))
      .fontFamily('mono')
      .whiteSpace('pre')
      .padding('.5rem')
      .backgroundColor('#eee')
      .up
    .Div(editor).margin('1rem 0').up
//      .add(childrenBlock(name))
    .Div(resultFrame(value)).margin('1rem 0').up
//      .add(inputsList());
};

function createUnit(name, value = ''){
  const codeBox = Box(value);
  codes.set(name, codeBox);
  
  let valueBox;
  if(missingItems[name]){
    valueBox = missingItems[name];
    delete missingItems[name];
  } else if (imports[name]) {
    valueBox = imports[name];
    delete imports[name];
  } else {
    valueBox = nice.LiveBox();
  }
  values.set(name, valueBox);
  
  names.push(name);
  codeBox.subscribe(code => valueBox(code));
  
  return codeBox;
}

function newView(){
  const input = Input();
  input
    .placeholder('Create new:')
    .on('keyup', e => {
      if(e.code === 'Enter'){
        const name = input.value();
        name && createUnit(name);
        input.value('');
        activeItem(name);
      }
    });
  return Div(input).margin('1rem 0');
}

function inputsList(a = ['map', 'H1']){
  return a.map(name => {
    const local = values.get(name);
    const lib = nice[name];
    return Div().color('#666')
      .b( local ? name : 'nice.'+name, ': ' )
      .add( local ? '' + local() : lib.description || ("" + lib));
  });
};

const namesList = RBox(names, activeItem, (ns, active) => {
  return Div(...ns.map(name => {
    return Div(name === active ? B(name) : name)
      .cursor('pointer')
      .add(' ', Span(nice.getType(resolve(name)()).name).color('#666'))
      .on('click', () => { activeItem(name); return false });
//    return RBox(resolve(name), value => 
//        Div(name === active ? B(name) : name)
//          .color(value._isErr || value  instanceof Error ? '#ce0404' : 'black')
//          .on('click', () => activeItem(name)));
  }));
});

const resultPane = RBox(activeItem, active => Div(values.get(active)));

function extractNames (code){
  const tokens = esprima.tokenize(code);
  const result = {};
  const ignored = {};
  let ignoreNext = false;
  
  tokens.forEach(({type, value}) => {
    if(type === 'Keyword'){
      if(value === 'var' || value === 'const' || value === 'let'){
        ignoreNext = true;
        return;
      }
    } else if (type === 'Identifier') {
      if(ignoreNext){
        ignored[value] = 1;
      } else {
        ignored[value] || (result[value] = 1);
      }
    }
    ignoreNext = false;
  });
  
  return result;
}



createUnit('mainPane', `Div()
  .h2('Hello ')
  .add(messages.map(m => Div(m)))
  .add(input)`);
createUnit('messages', `['Hi all']`);
createUnit('input', `Input().on('keyup', e => {
    if(e.code === 'Enter'){
      const input = e.srcElement;
      const text = input.value;
      input.value = '';
      input.dispatchEvent(new Event('change'));
      text && set('messages', [...get('messages'), text]);
    }
  })`);
  
var x = { 
  chats: {
    inbox: []
  },
  newMessageInput: Input(),
  currentChat: 'inbox',
  mainPane: Component({
//    args: { chatName: String },//??syntax
    input: ($, args) => ({
      current: $.currentChat,
      newMessageInput: $.newMessageInput
    }),//??syntax
    by: ($, ins, args) => {
      return Div().h2('Wellcome to ', ins.current)
//        .add($.messagesView({name: ins.current}))
        .rBox($.chats[args.name], messages => Div(messages.map(m => Div(m))))
        .add(ins.newMessageInput)
    },
  }),
  messagesList: ($) => {
    return Div(...$.chats.map(name => A(() => $.currentChat(name), name)))
  }
//  messagesView: Component({
//    args:  { name: String },
//    input: ($, args) => {
//      messages: $.chats[args.name]
//    },
//    by: ({ Div }, { messages }) => {
//      return Div(messages.map(m => Div(m)));
//    }
//  })
}

  
  
  
//  set('messages', [...get('messages'), text]);
//  or
//  messages.push(text);
//  or
//  addMessage(text);


Div(
  Div(newView(), namesList).backgroundColor('#bbb').padding('.5rem'),
  Div(RBox(activeItem, itemDetails))
    .overflow('auto').backgroundColor('#ddd').padding('.5rem'),
//  Div(resultPane).padding('.5rem')
).display('grid')
  .gridTemplateColumns('25% 75%')
  .height('100%')
  .show();

</script>
  </body>
</html>
