<html>
  <head>
    <title>Test page</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="../nice.js"></script>
    <!--<script src="https://unpkg.com/esprima@~4.0/dist/esprima.js"></script>-->
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js"></script>-->
  </head>
  <body>
    <main id="js-main" class="main"></main>
<script>
"use strict";
const { Box, Div, Span, H1, H2, H3, B, I, A, next, Html, Img } = nice;
const { Arr, Type, Check, Mapping, Switch, is, Single,
   get, expect, Num, Str, Obj,Test, Spy, Pointer } = nice;

class Storage{
  constructor(){
    this.version = 0;
    this.messages = [];
    this.rows = [];
    this.sessions = {};
    this.filters = {};

  }

  insert (row) {
    const id = this.rows.length;
    this.rows.push(row);

    Object.values(this.filters).forEach(f => {
      if(lib.match(f.query, row)){
        f.data.push(id);
        f.emit('data', f.data);
      }
    });

    return {
      id,
      ok: true
    };
  }

  update (id, row) {
    if(!this.checkId(id))
      return { ok: false, message: 'Bad id.'};
    
    //TODO: lookup filters
    Object.assign(this.rows[id], row);  
    //TODO: lookup filters
    
    //TODO: notify
    
    return { ok: true, newRow: this.rows[id] };
  }

  get ({query, cb, version}) {
    const filter = this.assertFilter(query);
    
    cb(filter.data);
  }
  
  subscribe ({query, cb, version}) {
    const filter = this.assertFilter(query);
    cb(filter.data);
    filter.on('data', data => cb(data));
  }
  
  assertFilter (query){
    const key = lib.normalizeQuery(query);
    const filters = this.filters;
    
    //TODO:  version,
    return filters[key] || (filters[key] = nice.eventEmitter({
      query,
      key,
      data: this.rows.reduce((a, row, id) => {
        if(lib.match(query, row)) 
          a.push(id);
        return a;
      }, [])
    }));
  }
  
  checkId(id){
    return id in this.rows;
  }
}


const lib = {
  normalizeQuery(q){
    return Object.keys(q).sort().map(k => `${k}:${q[k]}`).join('/');
  },
  
  match (query, row) {
    for (const [key, value] of Object.entries(query)) {
      if(row[key] !== value)
        return false;
    }
    return true;
  }};


const s = new Storage();
s.insert({type:'user', name:'Jim'});
s.insert({type:'user', name:'Jane'});


const q = {
  query: {type: 'user'},
  cb: data => console.log(data)
};

s.subscribe(q);

s.insert({type:'user', name:'Joe'});



</script>
  

  </body>
</html>
